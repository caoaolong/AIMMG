<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ story.name }} - 剧本详情</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.8.18/css/layui.min.css">
  <style>
    .scene-prompt { white-space: pre-wrap; margin: 8px 0; padding: 8px; background: #f8f8f8; border-radius: 4px; line-height: 1.8; }
    /* 角色列表：左侧图片 9:16，右侧 Tab 分幕 */
    .char-list-item { display: flex; align-items: flex-start; gap: 24px; margin-bottom: 32px; padding-bottom: 32px; border-bottom: 1px solid #eee; }
    .char-list-item:last-child { border-bottom: none; margin-bottom: 0; }
    .char-list-left { flex-shrink: 0; width: 180px; }
    .char-avatar-wrap { width: 100%; aspect-ratio: 9/16; overflow: hidden; background: #f0f0f0; border-radius: 4px; }
    .char-avatar-wrap .char-avatar { width: 100%; height: 100%; object-fit: cover; display: block; }
    .char-list-right { flex: 1; min-width: 0; }
    .char-list-right .layui-tab-title { margin-bottom: 0; }
    .char-list-right .layui-tab-content { padding: 12px 0; }
    .scene-prompt { white-space: pre-wrap; margin: 8px 0; padding: 8px; background: #f8f8f8; border-radius: 4px; line-height: 1.8; }
    .char-scene-content { line-height: 1.8; }
    .char-scene-content p, .char-scene-content li { line-height: 1.8; margin: 6px 0; }
    /* 角色页左侧固定导航 */
    .char-tab-pane { position: relative; }
    .char-nav { position: fixed; left: 0; top: 80px; bottom: 0; width: 140px; overflow-y: auto; background: #f8f8f8; border-right: 1px solid #eee; z-index: 10; padding: 12px 0; }
    .char-nav-title { padding: 0 12px 8px; font-size: 12px; color: #999; border-bottom: 1px solid #eee; margin-bottom: 8px; }
    .char-nav-list { list-style: none; margin: 0; padding: 0; }
    .char-nav-list li { margin: 0; }
    .char-nav a { display: block; padding: 8px 12px; color: #333; text-decoration: none; font-size: 14px; }
    .char-nav a:hover { background: #1E9FFF; color: #fff; }
    .char-list-wrap { margin-left: 160px; padding-left: 16px; }
    .char-list-item { scroll-margin-top: 24px; }
    /* 场景页左侧固定导航（与角色页同风格） */
    .scene-tab-pane { position: relative; }
    .scene-nav { position: fixed; left: 0; top: 80px; bottom: 0; width: 220px; overflow-y: auto; z-index: 10; padding: 12px 0; }
    .scene-nav .char-nav-title { padding: 0 12px 8px; font-size: 12px; color: #999; border-bottom: 1px solid #eee; margin-bottom: 8px; }
    .scene-nav .char-nav-list { list-style: none; margin: 0; padding: 0; }
    .scene-nav .char-nav-list li { margin: 0; }
    .scene-nav .char-nav-list ul { list-style: none; margin: 0 0 8px 0; padding: 0 0 0 8px; border-left: 1px solid #ddd; }
    .scene-nav a { display: block; padding: 6px 12px; color: #333; text-decoration: none; font-size: 13px; }
    .scene-nav a:hover { background: #1E9FFF; color: #fff; }
    .scene-nav .scene-title { padding: 6px 12px; font-size: 13px; font-weight: bold; color: #333; }
    .scene-content-wrap { margin-left: 180px; padding-left: 16px; }
    .scene-block { scroll-margin-top: 24px; }
    .scene-step-item { scroll-margin-top: 24px; }
    /* 道具页：可折叠面板 */
    .props-tab-pane { padding: 16px 0; }
    .props-tab-pane .layui-colla-item { border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 1px solid #eee; }
    .props-tab-pane .layui-colla-title { margin: 0; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); font-size: 15px; padding: 14px 16px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; min-height: 24px; }
    .props-tab-pane .layui-colla-title::before { flex-shrink: 0; margin-right: 4px; }
    .props-tab-pane .layui-colla-title .prop-panel-name { flex: 1; min-width: 0; }
    .props-tab-pane .layui-colla-title:hover { background: #f0f7ff; }
    .props-tab-pane .layui-colla-content { padding: 0; border-top: 1px solid #eee; background: #fafafa; }
    .prop-panel-count { font-size: 12px; color: #666; background: #e8e8e8; padding: 3px 10px; border-radius: 12px; }
    .prop-children-wrap { padding: 12px 16px; }
    .prop-child-item { background: #fff; border-radius: 6px; padding: 10px 14px; margin-bottom: 8px; border: 1px solid #eee; box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition: border-color 0.2s, box-shadow 0.2s; }
    .prop-child-item:last-child { margin-bottom: 0; }
    .prop-child-item:hover { border-color: #1E9FFF; box-shadow: 0 2px 8px rgba(30,159,255,0.12); }
    .prop-child-name { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; display: block; }
    .prop-child-desc { font-size: 13px; color: #666; line-height: 1.5; margin: 0; }
    .prop-empty-hint { padding: 16px; color: #999; font-size: 13px; text-align: center; }
    @media (max-width: 768px) {
      .char-nav, .scene-nav { display: none; }
      .char-list-wrap, .scene-content-wrap { margin-left: 0; padding-left: 0; }
      .char-list-item { flex-direction: column; }
      .char-list-left { width: 100%; max-width: 240px; margin: 0 auto; }
    }
  </style>
</head>
<body>
  <div class="layui-container" style="padding-top: 24px; padding-bottom: 48px;">
    <div class="layui-card">
      <div class="layui-card-header" style="display: flex; align-items: center; gap: 16px;">
        <a href="/" class="layui-btn layui-btn-sm layui-btn-primary">← 返回列表</a>
        <a href="{{ story.cover_url }}" target="_blank" style="flex-shrink: 0; width: 56px; height: 78px; overflow: hidden; background: #f0f0f0; border-radius: 4px; display: block;">
          <img src="{{ story.cover_url }}" alt="{{ story.name }}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.style.display='none'">
        </a>
        <span style="font-size: 18px;">{{ story.name }}</span>
      </div>
      <div class="layui-card-body">
        <div class="layui-tab layui-tab-brief" lay-filter="detail">
          <ul class="layui-tab-title">
            <li class="layui-this">场景</li>
            <li>角色</li>
            <li>道具</li>
          </ul>
          <div class="layui-tab-content">
            <div class="layui-tab-item layui-show scene-tab-pane">
              <nav class="scene-nav">
                <div class="char-nav-title">场景与步骤</div>
                <ul class="char-nav-list">
                  {% for scene in story.scenes %}
                  {% set scene_idx = loop.index0 %}
                  <li>
                    <div class="scene-title">第 {{ loop.index }} 幕 {{ scene.name or '未命名' }}</div>
                    <ul class="char-nav-list">
                      {% for step in scene.steps_display %}
                      <li><a href="#scene-{{ scene_idx }}-step-{{ loop.index0 }}">步骤 {{ loop.index }}</a></li>
                      {% endfor %}
                      {% if not scene.steps_display and (scene.notes or scene.choices) %}
                      <li><a href="#scene-{{ scene_idx }}">备注/选项</a></li>
                      {% endif %}
                    </ul>
                  </li>
                  {% endfor %}
                </ul>
              </nav>
              <div class="scene-content-wrap">
              {% for scene in story.scenes %}
              {% set scene_idx = loop.index0 %}
              <div class="scene-block" id="scene-{{ scene_idx }}" style="margin-bottom: 32px;">
                <h3 class="layui-font-16" style="margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                  第 {{ loop.index }} 幕 {% if scene.name %}{{ scene.name }}{% endif %}
                </h3>
                {% if scene.steps_display %}
                <ul class="layui-timeline">
                  {% for step in scene.steps_display %}
                  <li class="layui-timeline-item scene-step-item" id="scene-{{ scene_idx }}-step-{{ loop.index0 }}">
                    <i class="layui-icon layui-timeline-axis layui-icon-read" style="color: #1E9FFF;"></i>
                    <div class="layui-timeline-content layui-text">
                      <h4 class="layui-timeline-title">步骤 {{ loop.index }}</h4>
                      {% for block in step.blocks %}
                      <div class="step-block" style="margin-bottom: 12px;">
                        <span class="step-block-label" style="display: inline-block; font-size: 12px; color: #1E9FFF; margin-bottom: 6px;">{{ block.label }}</span>
                        {% for line in block.lines %}
                        <div class="scene-prompt">{{ line }}</div>
                        {% endfor %}
                      </div>
                      {% endfor %}
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
                {% if scene.notes %}
                <div style="margin-top: 12px;">
                  <h4 style="margin-bottom: 8px;">备注</h4>
                  <ul class="layui-list">
                    {% for n in scene.notes %}
                    <li>{{ n }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                {% if scene.choices %}
                <div style="margin-top: 12px;">
                  <h4 style="margin-bottom: 8px;">选项</h4>
                  <ul class="layui-list">
                    {% for key, val in scene.choices.items() %}
                    <li><strong>{{ key }}</strong>: {{ val.description if val is mapping else val }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
              </div>
              {% endfor %}
              </div>
            </div>
            <div class="layui-tab-item char-tab-pane">
              <nav class="char-nav">
                <div class="char-nav-title">角色</div>
                <ul class="char-nav-list">
                  {% for char in story.characters %}
                  <li><a href="#char-{{ loop.index0 }}" data-char-index="{{ loop.index0 }}">{{ char.name }}</a></li>
                  {% endfor %}
                </ul>
              </nav>
              <div class="char-list-wrap">
              {% for char in story.characters %}
              <div class="char-list-item" id="char-{{ loop.index0 }}">
                <div class="char-list-left">
                  <div class="char-avatar-wrap">
                    <img class="char-avatar" src="/results/{{ story_id }}/characters/{{ char.id }}.png" alt="{{ char.name }}" onerror="this.style.display='none'">
                  </div>
                </div>
                <div class="char-list-right">
                  <h3 style="margin: 0 0 8px 0;">{{ char.name }}</h3>
                  <p style="margin: 0 0 4px 0; color: #666;"><strong>简介</strong> {{ char.description or '-' }}</p>
                  <p style="margin: 0 0 16px 0; color: #666;"><strong>介绍</strong> {{ char.introduction or '-' }}</p>
                  {% if char.scenes %}
                  <div class="layui-tab layui-tab-brief char-scene-content" lay-filter="char-{{ loop.index0 }}">
                    <ul class="layui-tab-title">
                      {% for s_block in char.scenes %}
                      <li class="{% if loop.first %}layui-this{% endif %}">第 {{ loop.index }} 幕</li>
                      {% endfor %}
                    </ul>
                    <div class="layui-tab-content">
                      {% for s_block in char.scenes %}
                      <div class="layui-tab-item {% if loop.first %}layui-show{% endif %}">
                        {% if s_block.prompts %}
                        <div style="margin-bottom: 12px;">
                          {% for p in s_block.prompts %}
                          <div class="scene-prompt">{{ p }}</div>
                          {% endfor %}
                        </div>
                        {% endif %}
                        {% if s_block.tasks %}
                        <div style="margin-bottom: 12px;"><strong>任务</strong>
                          <ul class="layui-list">
                            {% for t in s_block.tasks %}
                            <li>{{ t }}</li>
                            {% endfor %}
                          </ul>
                        </div>
                        {% endif %}
                        {% if s_block.skills %}
                        <div style="margin-bottom: 12px;"><strong>技能/说明</strong>
                          <ul class="layui-list">
                            {% for sk in s_block.skills %}
                            <li>{{ sk }}</li>
                            {% endfor %}
                          </ul>
                        </div>
                        {% endif %}
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
              </div>
            </div>
            <div class="layui-tab-item props-tab-pane">
              <h4 style="margin: 0 0 20px 0; font-size: 16px; color: #333;">道具清单</h4>
              {% if story.props %}
              <div class="layui-collapse" lay-filter="props-collapse">
                {% for prop in story.props %}
                <div class="layui-colla-item">
                  <h2 class="layui-colla-title">
                    <span class="prop-panel-name">{{ prop.name }}</span>
                    {% if prop.count is defined %}<span class="prop-panel-count">{{ prop.count }} 张/个</span>{% endif %}
                  </h2>
                  <div class="layui-colla-content">
                    {% if prop.children %}
                    <div class="prop-children-wrap">
                      {% for child in prop.children %}
                      <div class="prop-child-item">
                        <span class="prop-child-name">{{ child.name }}</span>
                        {% if child.description %}<p class="prop-child-desc">{{ child.description }}</p>{% endif %}
                      </div>
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="prop-empty-hint">无子项</div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <p class="layui-text" style="color: #999;">暂无道具信息。</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.8.18/layui.min.js"></script>
  <script>
    layui.use(['element'], function(){
      var element = layui.element;
      element.render('collapse');
    });
    document.querySelectorAll('.char-nav a[data-char-index]').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var id = 'char-' + link.getAttribute('data-char-index');
        var el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
    document.querySelectorAll('.scene-nav a[href^="#"]').forEach(function(link) {
      link.addEventListener('click', function(e) {
        var href = this.getAttribute('href');
        if (href && href.length > 1) {
          e.preventDefault();
          var id = href.slice(1);
          var el = document.getElementById(id);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  </script>
</body>
</html>
